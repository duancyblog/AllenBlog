---
import Comment from "@components/comment/index.astro";
import { Icon } from "astro-icon/components";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import { fetchEch0Posts } from "../utils/ech0-api";

// 从Ech0 API获取动态数据
const essays = await fetchEch0Posts("https://say.allen2030.com");

// 为评论区创建一个模拟的post对象
const mockPost = {
	slug: "essay",
	data: {
		title: "瞬间",
	},
};
---

<MainGridLayout title="瞬间" description="记录生活中的美好瞬间">
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32 mb-8">
        <div class="card-base z-10 px-9 py-6 relative w-full">
            <h1 class="text-4xl font-bold mb-6 text-neutral-900 dark:text-white">说说</h1>
            <p class="text-neutral-600 dark:text-neutral-400 mb-8">Ech0 API智能获取</p>
            
            <div class="space-y-6">
                {essays.map((essay) => (
                    <div class="essay-item bg-[var(--card-bg)] rounded-lg p-6 shadow-sm border border-[var(--line-divider)] transition-all hover:shadow-md">
                        <!-- 内容 -->
                        <div class="essay-content text-90 text-lg leading-relaxed mb-4">
                            {essay.content}
                        </div>
                        
                        <!-- 图片 -->
                        {essay.images && essay.images.length > 0 && (
                            <div class="essay-images mb-4">
                                <div class:list={[
                                    "custom-md grid gap-3",
                                    essay.images.length === 1 ? "grid-cols-1" : 
                                    essay.images.length === 2 ? "grid-cols-2" :
                                    essay.images.length === 3 ? "grid-cols-3" :
                                    "grid-cols-2 md:grid-cols-3"
                                ]}>
                                    {essay.images.map((image, index) => (
                                        <div class="rounded-lg overflow-hidden bg-[var(--btn-card-bg-hover)]">
                                            <img 
                                                src={image} 
                                                alt={`瞬间图片 ${index + 1}`}
                                                class="w-full h-48 object-cover hover:scale-105 transition-transform duration-300 cursor-pointer"
                                                loading="lazy"
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        <!-- 底部信息 -->
                        <div class="essay-meta flex items-center justify-between text-sm text-75">
                            <div class="flex items-center gap-4">
                                <!-- 时间 -->
                                <div class="flex items-center gap-1">
                                    <Icon name="material-symbols:schedule" class="text-base" />
                                    <span>{essay.time}</span>
                                </div>
                                
                                <!-- 标签 -->
                                {essay.tags && essay.tags.length > 0 && (
                                    <div class="flex items-center gap-2">
                                        <Icon name="material-symbols:tag" class="text-base" />
                                        <div class="flex gap-2">
                                            {essay.tags.map((tag) => (
                                                <span class="px-2 py-1 bg-[var(--btn-card-bg-hover)] rounded-full text-xs">
                                                    {tag}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            <!-- 评论按钮 -->
                            <div>
                                <button 
                                    class="flex items-center gap-1 text-sm hover:text-primary transition-colors"
                                    data-content={`${essay.content}`}
                                    onclick="window.commentOnPost(this)"
                                >
                                    <Icon name="material-symbols:chat" class="text-base" />
                                    <span>评论</span>
                                </button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    </div>

    <!-- 评论区 -->
    <div id="comments-section" class="twikoo-container">
        <Comment path="/essay/" />
    </div>
</MainGridLayout>



<style>
    .essay-item {
        animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .essay-content {
        word-wrap: break-word;
        white-space: pre-wrap;
    }
</style>

<script>
    // 全局评论函数
    window.commentOnPost = function(button) {
        const content = button.dataset.content;
        console.log('commentOnPost called with content:', content);
        
        // 滚动到评论区
        const commentsSection = document.getElementById('comments-section');
        if (commentsSection) {
            console.log('Found comments section, scrolling...');
            commentsSection.scrollIntoView({ behavior: 'smooth' });
        } else {
            console.log('Comments section not found, scrolling to bottom...');
            window.scrollTo({ 
                top: document.body.scrollHeight, 
                behavior: 'smooth' 
            });
        }
        
        // 增加延迟时间，确保滚动完成且Twikoo完全加载
        setTimeout(() => {
            console.log('Trying to find textarea...');
            // 尝试找到Twikoo输入框
            const textarea = document.querySelector('.el-textarea__inner') || 
                           document.querySelector('#twikoo textarea') || 
                           document.querySelector('textarea');
            
            if (textarea) {
                console.log('Found textarea:', textarea);
                // 填充引用内容
                textarea.value = `> ${content}\n\n`;
                // 聚焦输入框
                textarea.focus();
                // 触发输入事件
                textarea.dispatchEvent(new Event('input', { bubbles: true }));
                console.log('Content filled into textarea');
            } else {
                console.log('Textarea not found, trying again...');
                // 再次尝试
                setTimeout(() => {
                    const retryTextarea = document.querySelector('.el-textarea__inner') || 
                                         document.querySelector('textarea');
                    if (retryTextarea) {
                        console.log('Found textarea on retry:', retryTextarea);
                        retryTextarea.value = `> ${content}\n\n`;
                        retryTextarea.focus();
                        retryTextarea.dispatchEvent(new Event('input', { bubbles: true }));
                        console.log('Content filled into textarea on retry');
                    } else {
                        console.log('Textarea still not found');
                    }
                }, 500);
            }
        }, 800);
    };
</script>